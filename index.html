<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>خريطة تفاعلية فورية</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    background: black;
    height: 100vh;
    overflow: auto;
    display: flex;
    justify-content: center;
    align-items: flex-start;
  }
  svg {
    display: block;
    max-width: 100vw;
    height: 100%;
    width: auto;
  }
  .image-mapper-shape {
    fill: transparent;
    stroke: yellow;
    stroke-width: 2px;
    cursor: pointer;
    pointer-events: all;
    transition: transform 0.2s ease, filter 0.2s ease;
  }
  .zoom-part {
    pointer-events: none;
    transition: transform 0.2s ease, filter 0.2s ease, opacity 0.2s ease;
  }
</style>
</head>
<body>

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 2048 4908" preserveAspectRatio="xMidYMid meet">
  <defs id="clip-defs"></defs>

  <g id="group-1"><image href="image/1.png" width="1024" height="2454"/></g>
  <g id="group-2" transform="translate(1024,0)"><image href="image/2.png" width="1024" height="2454"/></g>
  <g id="group-3" transform="translate(0,2454)"><image href="image/3.png" width="1024" height="2454"/></g>
  <g id="group-4" transform="translate(1024,2454)"><image href="image/4.png" width="1024" height="2454"/></g>

  <g id="hotspots">
    <a href="block/physio/1.pdf" target="_blank"><rect x="254" y="423" width="114" height="467" class="image-mapper-shape"/></a>
    <a href="block/histo/1.pdf" target="_blank"><rect x="253" y="1403" width="114" height="438" class="image-mapper-shape"/></a>
    <a href="block/physio/2.pdf" target="_blank"><rect x="484" y="314" width="113" height="459" class="image-mapper-shape"/></a>
    <a href="block/pharma/1.pdf" target="_blank"><rect x="599" y="422" width="112" height="471" class="image-mapper-shape"/></a>
    <a href="block/physio/3.pdf" target="_blank"><rect x="488" y="1838" width="108" height="441" class="image-mapper-shape"/></a>
    <a href="block/bio/1.pdf" target="_blank"><rect x="599" y="893" width="112" height="511" class="image-mapper-shape"/></a>
  </g>
</svg>

<script>
const clipDefs = document.getElementById('clip-defs');
let activeHover = null;

document.querySelectorAll('.image-mapper-shape').forEach((rect, index) => {
  let zoomPart = null;
  let clipPathId = `clip-${index}`;
  let animationId = null;
  const scale = 1.1;

  const parentSVG = rect.ownerSVGElement;
  const rectBBox = rect.getBBox();

  // تحديد الصورة الأساسية تحت المستطيل
  let baseImage = Array.from(parentSVG.querySelectorAll('image')).find(img=>{
    const imgBBox = img.getBBox();
    return rectBBox.x >= imgBBox.x && rectBBox.y >= imgBBox.y &&
           rectBBox.x + rectBBox.width <= imgBBox.x + imgBBox.width &&
           rectBBox.y + rectBBox.height <= imgBBox.y + imgBBox.height;
  }) || parentSVG.querySelector('image');

  const imageURL = baseImage.getAttribute('href');
  const imageWidth = parseFloat(baseImage.getAttribute('width'));
  const imageHeight = parseFloat(baseImage.getAttribute('height'));

  // ===== ماوس =====
  rect.addEventListener('mouseenter', startHover);
  rect.addEventListener('mouseleave', stopHover);

  // ===== لمس بدون أي تأخير =====
  rect.addEventListener('touchstart', e => { 
    e.preventDefault();
    startHover();
  }, {passive:false});

  rect.addEventListener('touchend', e => {
    if(activeHover) stopHover();
    const link = rect.closest('a');
    if(link) window.open(link.href, link.target || '_self');
  });

  function startHover() {
    if(activeHover === rect) return;
    activeHover = rect;

    const clip = document.createElementNS('http://www.w3.org/2000/svg','clipPath');
    clip.setAttribute('id', clipPathId);
    const clipRect = document.createElementNS('http://www.w3.org/2000/svg','rect');
    clipRect.setAttribute('x', rectBBox.x);
    clipRect.setAttribute('y', rectBBox.y);
    clipRect.setAttribute('width', rectBBox.width);
    clipRect.setAttribute('height', rectBBox.height);
    clip.appendChild(clipRect);
    clipDefs.appendChild(clip);

    zoomPart = document.createElementNS('http://www.w3.org/2000/svg','image');
    zoomPart.setAttribute('href', imageURL);
    zoomPart.setAttribute('width', imageWidth);
    zoomPart.setAttribute('height', imageHeight);
    zoomPart.setAttribute('clip-path', `url(#${clipPathId})`);
    zoomPart.setAttribute('x', baseImage.x.baseVal.value);
    zoomPart.setAttribute('y', baseImage.y.baseVal.value);
    zoomPart.setAttribute('class','zoom-part');
    parentSVG.appendChild(zoomPart);

    rect.style.transformOrigin = `${rectBBox.x + rectBBox.width/2}px ${rectBBox.y + rectBBox.height/2}px`;
    rect.style.transform = `scale(${scale})`;
    zoomPart.style.transformOrigin = `${rectBBox.x + rectBBox.width/2}px ${rectBBox.y + rectBBox.height/2}px`;
    zoomPart.style.transform = `scale(${scale})`;

    let hue = 0;
    animationId = setInterval(()=>{
      hue = (hue+1)%360;
      const glow = `drop-shadow(0 0 8px hsl(${hue},100%,55%)) drop-shadow(0 0 14px hsl(${(hue+60)%360},100%,60%))`;
      rect.style.filter = glow;
      zoomPart.style.filter = glow;
    },100);
  }

  function stopHover() {
    if(!activeHover) return;
    rect.style.transform = 'scale(1)';
    rect.style.filter = 'none';
    if(animationId) clearInterval(animationId);
    if(zoomPart) zoomPart.remove();
    const existingClip = document.getElementById(clipPathId);
    if(existingClip) existingClip.remove();
    activeHover = null;
  }
});
</script>

</body>
</html>