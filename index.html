<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>خريطة تفاعلية مع Hover ولمس</title>
<style>
html, body {
  margin: 0;
  padding: 0;
  background: black;
  height: 100vh;
  overflow: hidden;
  display: flex;
  justify-content: center;
  align-items: flex-start;
}
svg {
  display: block;
  height: 100%;
  width: auto;
}
.image-mapper-shape {
  fill: transparent;
  stroke: yellow;
  stroke-width: 2px;
  transform-origin: center center;
  transition: transform 0.3s ease, filter 0.3s ease;
}
.zoom-part {
  pointer-events: none;
  transition: transform 0.3s ease, filter 0.3s ease, opacity 0.3s ease;
}
</style>
</head>
<body>

<svg id="interactive-map" xmlns="http://www.w3.org/2000/svg"
     viewBox="0 0 2048 4908" preserveAspectRatio="xMidYMid meet">
  <defs id="clip-defs"></defs>

  <!-- الصور والمناطق -->
  <g transform="translate(0,0)">
    <image href="image/1.png" width="1024" height="2454" class="base-image"/>
    <a href="block/physio/1.pdf" target="_blank"><rect x="254" y="423" width="114" height="467" class="image-mapper-shape"/></a>
    <a href="block/histo/1.pdf" target="_blank"><rect x="253" y="1403" width="114" height="438" class="image-mapper-shape"/></a>
    <a href="block/physio/2.pdf" target="_blank"><rect x="484" y="314" width="113" height="459" class="image-mapper-shape"/></a>
    <a href="block/pharma/1.pdf" target="_blank"><rect x="599" y="422" width="112" height="471" class="image-mapper-shape"/></a>
    <a href="block/physio/3.pdf" target="_blank"><rect x="488" y="1838" width="108" height="441" class="image-mapper-shape"/></a>
    <a href="block/bio/1.pdf" target="_blank"><rect x="599" y="893" width="112" height="511" class="image-mapper-shape"/></a>
  </g>
</svg>

<script>
const clipDefs = document.getElementById('clip-defs');
let activeHover = null;

document.querySelectorAll('.image-mapper-shape').forEach((rect, index) => {
  let zoomPart = null;
  let clipPathId = `clip-${index}`;
  let animationId = null;
  const scale = 1.1;
  let touchTimer = null;

  const parentGroup = rect.closest('g');
  const baseImage = parentGroup.querySelector('.base-image');
  const imageURL = baseImage.getAttribute('href');
  const imageWidth = parseFloat(baseImage.getAttribute('width'));
  const imageHeight = parseFloat(baseImage.getAttribute('height'));
  const transform = parentGroup.getAttribute('transform') || '';
  let [offsetX, offsetY] = [0, 0];
  const match = transform.match(/translate\(([^,]+),([^)]+)\)/);
  if (match) { offsetX = parseFloat(match[1]); offsetY = parseFloat(match[2]); }

  rect.addEventListener('touchstart', e => {
    e.preventDefault();
    touchTimer = setTimeout(() => startHover(), 0); // delay 0
  }, { passive: false });

  rect.addEventListener('touchend', e => {
    if (touchTimer) clearTimeout(touchTimer);
    if (!activeHover) {
      const link = rect.closest('a');
      if (link) window.open(link.href, link.target || '_self');
      return;
    }
    stopHover();
    const link = rect.closest('a');
    if (link) window.open(link.href, link.target || '_self');
  });

  rect.addEventListener('touchcancel', stopHover);

  function startHover() {
    activeHover = rect;
    const x = parseFloat(rect.getAttribute('x'));
    const y = parseFloat(rect.getAttribute('y'));
    const width = parseFloat(rect.getAttribute('width'));
    const height = parseFloat(rect.getAttribute('height'));

    const clip = document.createElementNS('http://www.w3.org/2000/svg', 'clipPath');
    clip.setAttribute('id', clipPathId);
    const clipRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
    clipRect.setAttribute('x', x + offsetX);
    clipRect.setAttribute('y', y + offsetY);
    clipRect.setAttribute('width', width);
    clipRect.setAttribute('height', height);
    clip.appendChild(clipRect);
    clipDefs.appendChild(clip);

    zoomPart = document.createElementNS('http://www.w3.org/2000/svg', 'image');
    zoomPart.setAttribute('href', imageURL);
    zoomPart.setAttribute('width', imageWidth);
    zoomPart.setAttribute('height', imageHeight);
    zoomPart.setAttribute('class', 'zoom-part');
    zoomPart.setAttribute('clip-path', `url(#${clipPathId})`);
    zoomPart.setAttribute('x', offsetX);
    zoomPart.setAttribute('y', offsetY);
    zoomPart.style.transformOrigin = `${x + width/2 + offsetX}px ${y + height/2 + offsetY}px`;
    zoomPart.style.opacity = 1;
    rect.ownerSVGElement.appendChild(zoomPart);

    rect.style.transformOrigin = `${x + width/2}px ${y + height/2}px`;
    rect.style.transform = `scale(${scale})`;

    let hue = 0;
    animationId = setInterval(() => {
      hue = (hue + 1) % 360;
      const glow = `drop-shadow(0 0 8px hsl(${hue},100%,55%)) drop-shadow(0 0 14px hsl(${(hue+60)%360},100%,60%))`;
      rect.style.filter = glow;
      zoomPart.style.filter = glow;
    }, 100);
  }

  function stopHover() {
    if (!activeHover) return;
    rect.style.transform = 'scale(1)';
    rect.style.filter = 'none';
    if (animationId) clearInterval(animationId);
    if (zoomPart) zoomPart.remove();
    const existingClip = document.getElementById(clipPathId);
    if (existingClip) existingClip.remove();
    activeHover = null;
  }
});
</script>

</body>
</html>